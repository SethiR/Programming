# Avro File

- [Avro Schema Details](https://docs.oracle.com/database/nosql-12.1.3.0/GettingStartedGuide/avroschemas.html#avro-complexdatatypes)

## Basics


- [Avro Docs](https://avro.apache.org/docs/current/gettingstartedjava.html)
- [Tutorial](http://hadooptutorial.info/avro-serializing-and-deserializing-example-java-api/)

A quick poc where I used a maven project for dependencies on Intellij with Java8 to create avro file. Steps given below.

Create a pom.xml with org.apache.avro dependency and the below mentioned build plugin.

```xml
<!-- pom.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>org.me</groupId>
    <artifactId>PracticingJava</artifactId>
    <version>1.0-SNAPSHOT</version>
    <dependencies>
        <dependency>
            <groupId>org.apache.avro</groupId>
            <artifactId>avro</artifactId>
            <version>1.10.0</version>
        </dependency>
    </dependencies>

    <properties>
        <maven.compiler.source>1.8</maven.compiler.source>
        <maven.compiler.target>1.8</maven.compiler.target>
    </properties>

    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.avro</groupId>
                <artifactId>avro-maven-plugin</artifactId>
                <version>1.10.0</version>
                <executions>
                    <execution>
                        <phase>generate-sources</phase>
                        <goals>
                            <goal>schema</goal>
                        </goals>
                        <configuration>
                            <sourceDirectory>${project.basedir}/src/main/resources/avro/</sourceDirectory>
                            <outputDirectory>${project.basedir}/src/main/java/</outputDirectory>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <configuration>
                    <source>1.8</source>
                    <target>1.8</target>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

To create a avro file you need to define a avro schema in `.avsc` file. as shown below. I created a `user.avsc` file in Resources dir. Pay attention to `sourceDirectory` and `outputDirectory` in pom xml. `sourceDirectory` should have the avsc file and the `outputDirectory` is where the build class will appear.


```json
{"namespace": "example.avro",
 "type": "record",
 "name": "User",
 "fields": [
     {"name": "name", "type": "string"},
     {"name": "favorite_number",  "type": ["int", "null"]},
     {"name": "favorite_color", "type": ["string", "null"]}
 ]
}
```

Once done creating the avsc file, you can go to maven tab/side bar in intellij and click `lifecycle --> package` which will build the package and create the `User` class in the `sourceDirectory`. Now you can use the class in your code.

```java
import example.avro.User;
import org.apache.avro.file.DataFileWriter;
import org.apache.avro.io.DatumWriter;
import org.apache.avro.specific.SpecificDatumWriter;

import java.io.File;
import java.io.IOException;

public class Main12 {
    public static void main(String[] args) throws IOException {

        User user = new User("Sam Nelson",11,"red12");  // User class generated by maven.

        // Setting data
        user.setName("Sam Nelson");
        user.setFavoriteColor("red");
        user.setFavoriteNumber(12);

        // Saving the avro file on disk.
        File file = new File("user.avro");
        DatumWriter<User> userDatumWriter = new SpecificDatumWriter<>(User.class);
        DataFileWriter<User> dataFileWriter = new
                DataFileWriter<User>(userDatumWriter);
        dataFileWriter.create(user.getSchema(), file);
        dataFileWriter.append(user);
        dataFileWriter.close();
    }
}
```

Once you run the above it will create a "user.avro" file.

Another working avro schema given below.

```json
{
    "type": "record",
    "name": "userInfo",
    "namespace": "example.avro",
    "fields": [
        {
            "name": "username",
            "type": "string",
            "default": "NONE"
        },
        {
            "name": "age",
            "type": "int",
            "default": -1
        },
        {
            "name": "address",
            "type": {
                "type": "record",
                "name": "mailing_address",
                "fields": [
                    {
                        "name": "street",
                        "type": "string",
                        "default": "NONE"
                    },
                    {
                        "name": "city",
                        "type": "string",
                        "default": "NONE"
                    },
                    {
                        "name": "state_prov",
                        "type": "string",
                        "default": "NONE"
                    },
                    {
                        "name": "country",
                        "type": "string",
                        "default": "NONE"
                    },
                    {
                        "name": "zip",
                        "type": "string",
                        "default": "NONE"
                    }
                ]
            },
            "default": {}
        }
    ]
}
```